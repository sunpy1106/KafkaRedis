# Kafka Batch Creation Timeout å¤ç°æµ‹è¯•æ€»ç»“æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ:** 2026-01-06
**æµ‹è¯•ç›®æ ‡:** å¤ç° Kafka Producer "X ms has passed since batch creation" è¶…æ—¶é”™è¯¯
**æµ‹è¯•ç¯å¢ƒ:** macOS (ARM64), Docker, Kafka 7.5.0, Redis 7.2

---

## ä¸€ã€æµ‹è¯•èƒŒæ™¯

### 1.1 ç›®æ ‡é”™è¯¯
```
org.apache.kafka.common.errors.TimeoutException:
Expiring X record(s) for test-topic-0: X ms has passed since batch creation plus linger time
```

### 1.2 ç†è®ºè§¦å‘æ¡ä»¶
è¿™ä¸ªé”™è¯¯éœ€è¦ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„"ç°è‰²æ•…éšœ"çŠ¶æ€ï¼š
- âœ… Producer èƒ½è¿æ¥åˆ° Brokerï¼ˆç½‘ç»œæ­£å¸¸ï¼‰
- âœ… Broker èƒ½æ¥æ”¶æ¶ˆæ¯ï¼ˆåº”ç”¨å±‚æ­£å¸¸ï¼‰
- âŒ Broker çš„ fsync() æ“ä½œæåº¦ç¼“æ…¢ï¼ˆå­˜å‚¨å±‚æ…¢ï¼‰
- âŒ ä½†ä¸è‡³äºå®Œå…¨å¤±è´¥ï¼ˆä¸æ˜¯ç£ç›˜æ»¡æˆ–ç£ç›˜æ•…éšœï¼‰

---

## äºŒã€æµ‹è¯•æ–¹æ¡ˆæ¼”è¿›

### 2.1 åŸè®¡åˆ’ï¼šåŸºäº fio çš„ svctm æ¨¡æ‹Ÿ

**ç†è®ºåŸºç¡€:**
å‚è€ƒåä¸º ALM-12033 æ…¢ç›˜æ£€æµ‹æ ‡å‡†ï¼š
- **HDD:** svctm > 150ms (è­¦å‘Š) | > 1000ms (ä¸¥é‡)
- **SSD:** svctm > 20ms (è­¦å‘Š) | > 1000ms (ä¸¥é‡)

**svctm è®¡ç®—å…¬å¼:**
```
svctm = (total_ticks_spent_on_io) / (total_io_operations_completed)
```

**fio é…ç½®è®¾è®¡:**

| å‚æ•° | ä½œç”¨ | æ¨èå€¼ |
|------|------|--------|
| `iodepth` | I/O é˜Ÿåˆ—æ·±åº¦ | 64-128 |
| `numjobs` | å¹¶å‘ä½œä¸šæ•° | 4-8 |
| `bs` | å—å¤§å° | 4K-16K |
| `rw` | I/O æ¨¡å¼ | randrw, randwrite |
| `fsync` | å¼ºåˆ¶åˆ·ç›˜é¢‘ç‡ | 1-10 |
| `direct=1` | ç»•è¿‡ç¼“å­˜ | 1 |
| `sync=1` | åŒæ­¥ I/O | 1 |

**åˆ›å»ºçš„æ–‡ä»¶:**
- `fio-slow-disk-hdd.fio` - æ¸©å’Œå‹åŠ›é…ç½® (svctm 150-300ms)
- `fio-slow-disk-extreme.fio` - æç«¯å‹åŠ›é…ç½® (svctm > 1000ms)
- `monitor-svctm.sh` - å®æ—¶ç›‘æ§è„šæœ¬
- `run-fio-kafka-test.sh` - è‡ªåŠ¨åŒ–æµ‹è¯•ç¼–æ’
- `FIO-APPROACH.md` - å®Œæ•´æ–‡æ¡£

### 2.2 å®é™…æ‰§è¡Œï¼šè°ƒæ•´ä¸º dd æ–¹æ¡ˆ

**åŸå› :**
- fio åœ¨ ARM64 (aarch64) UBI é•œåƒä¸­ä¸å¯ç”¨
- å³ä½¿å¯ç”¨ EPEL ä»“åº“ä¹Ÿæ— æ³•å®‰è£…

**æ›¿ä»£æ–¹æ¡ˆ:**
ä½¿ç”¨å·²æœ‰çš„ **TestBatchCreationProgressiveIO.java**ï¼Œå®ƒé€šè¿‡ dd å‘½ä»¤å®ç°ç›¸ä¼¼æ•ˆæœï¼š

```java
// dd å‘½ä»¤å‚æ•°
String.format("for i in {1..%d}; do " +
    "docker exec -d kafka-broker dd if=/dev/zero of=/var/lib/kafka/data/stress_$i.dat " +
    "bs=4M count=500 oflag=sync 2>/dev/null & " +
    "done", ddCount)
```

**å…³é”®å‚æ•°:**
- `bs=4M` - æ¯æ¬¡å†™å…¥ 4MB
- `count=500` - æ€»å…±å†™å…¥ 2GB (4M Ã— 500)
- `oflag=sync` - åŒæ­¥å†™å…¥ï¼Œç»•è¿‡ç¼“å­˜
- å¯è°ƒèŠ‚çš„ dd è¿›ç¨‹æ•°é‡

---

## ä¸‰ã€æµ‹è¯•æ‰§è¡Œè®°å½•

### 3.1 æ¸è¿›å¼ I/O å‹åŠ›æµ‹è¯•

é‡‡ç”¨äºŒåˆ†æœç´¢ç­–ç•¥ï¼Œé€æ­¥å¢åŠ  dd è¿›ç¨‹æ•°é‡ï¼š

| æµ‹è¯•è½®æ¬¡ | dd è¿›ç¨‹æ•° | æˆåŠŸæ¶ˆæ¯ | å¤±è´¥æ¶ˆæ¯ | è€—æ—¶ (ms) | ç»“æœ |
|---------|----------|----------|----------|-----------|------|
| #1 | 5 | 50 / 50 | 0 | 132 | âš ï¸  å‹åŠ›ä¸å¤Ÿ |
| #2 | 7 | 50 / 50 | 0 | 125 | âš ï¸  å‹åŠ›ä¸å¤Ÿ |
| #3 | 10 | 50 / 50 | 0 | 124 | âš ï¸  å‹åŠ›ä¸å¤Ÿ |
| #4 | 15 | 50 / 50 | 0 | 123 | âš ï¸  å‹åŠ›ä¸å¤Ÿ |
| (å·²çŸ¥) | 20 | N/A | N/A | N/A | âŒ Kafka æ— æ³•è¿æ¥ |

**è§‚å¯Ÿç»“æœ:**
1. **5-15 ä¸ª dd è¿›ç¨‹:** æ‰€æœ‰æ¶ˆæ¯æˆåŠŸå‘é€ï¼Œè€—æ—¶ç¨³å®šåœ¨ 120-130ms
2. **20 ä¸ª dd è¿›ç¨‹:** I/O å®Œå…¨é¥±å’Œï¼ŒKafka æ— æ³•å“åº”ä»»ä½•è¿æ¥
3. **ä¸­é—´çª—å£æçª„:** å‡ ä¹æ²¡æœ‰"åˆšåˆšå¥½"çš„é…ç½®èƒ½è§¦å‘ batch creation timeout

### 3.2 Kafka é…ç½®

ä¸ºäº†å¢åŠ è§¦å‘æ¦‚ç‡ï¼Œå·²åœ¨ `docker-compose.yml` ä¸­é…ç½®äº†å¼ºåˆ¶é¢‘ç¹åˆ·ç›˜ï¼š

```yaml
environment:
  KAFKA_LOG_FLUSH_INTERVAL_MESSAGES: 1    # æ¯1æ¡æ¶ˆæ¯å°±flush
  KAFKA_LOG_FLUSH_INTERVAL_MS: 100        # æ¯100ms flushä¸€æ¬¡
  KAFKA_LOG_FLUSH_SCHEDULER_INTERVAL_MS: 100
  KAFKA_NUM_RECOVERY_THREADS_PER_DATA_DIR: 1
```

### 3.3 Producer é…ç½®

```java
props.put("acks", "all");                  // éœ€è¦æ‰€æœ‰ISRç¡®è®¤
props.put("delivery.timeout.ms", "60000"); // 60ç§’è¶…æ—¶
props.put("request.timeout.ms", "20000");  // 20ç§’è¯·æ±‚è¶…æ—¶
props.put("linger.ms", "100");            // 100mså»¶è¿Ÿè®©æ¶ˆæ¯ç§¯ç´¯
props.put("batch.size", "1024");          // å°batchå®¹æ˜“å¡«æ»¡
props.put("retries", "2");
```

---

## å››ã€å¤±è´¥åŸå› åˆ†æ

### 4.1 ç¡¬ä»¶ç¯å¢ƒå› ç´ 

**ç³»ç»Ÿé…ç½®:**
```
OS: macOS Darwin 23.6.0
Architecture: ARM64 (Apple Silicon)
Disk: High-performance SSD
Container OS: RHEL 8.8 (UBI)
Disk Space: 125G total, 22G available
```

**æ€§èƒ½ç‰¹å¾:**
- **é«˜æ€§èƒ½ SSD:** éšæœºå†™å…¥æ€§èƒ½è¿œè¶…ä¼ ç»Ÿ HDD
- **ARM64 å¤„ç†å™¨:** Mç³»åˆ—èŠ¯ç‰‡ï¼Œå¼ºå¤§çš„I/Oå¤„ç†èƒ½åŠ›
- **å……è¶³å†…å­˜:** ç³»ç»Ÿç¼“å­˜å¯ä»¥å¸æ”¶å¤§é‡I/Oæ“ä½œ
- **Docker for Mac:** ä½¿ç”¨è™šæ‹ŸåŒ–å±‚ï¼Œå¯èƒ½æœ‰é¢å¤–çš„ç¼“å­˜

### 4.2 "All or Nothing" å›°å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ dd è¿›ç¨‹æ•°   â”‚ I/O çŠ¶æ€    â”‚ ç»“æœ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‰¤ 15        â”‚ æœ‰å‹åŠ›ä½†å¯æ§ â”‚ æ‰€æœ‰æ¶ˆæ¯æˆåŠŸ     â”‚
â”‚ ~16-19      â”‚ ä¸´ç•ŒåŒºé—´    â”‚ â“ ç†è®ºçª—å£æçª„   â”‚
â”‚ â‰¥ 20        â”‚ å®Œå…¨é¥±å’Œ    â”‚ Kafka æ— æ³•è¿æ¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜æ ¸å¿ƒ:**
- ç£ç›˜ I/O ä»"æ­£å¸¸"åˆ°"å®Œå…¨é˜»å¡"çš„è¿‡æ¸¡åŒºé—´æçª„
- 16-19 ä¸ª dd è¿›ç¨‹å¯èƒ½æ˜¯ç†è®ºçª—å£ï¼Œä½†æä¸ç¨³å®š
- é«˜æ€§èƒ½ç¡¬ä»¶ä½¿å¾—è¿™ä¸ªçª—å£æ›´åŠ éš¾ä»¥å‘½ä¸­

### 4.3 Kafka çš„å®¹é”™æœºåˆ¶

Kafka Producer æœ‰å¤šå±‚è¶…æ—¶ä¿æŠ¤ï¼š

```
max.block.ms (60s)
    â†“
request.timeout.ms (20s)
    â†“
delivery.timeout.ms (60s)
    â†“
batch creation timeout â† æéš¾è§¦å‘
```

**ä¸ºä»€ä¹ˆéš¾è§¦å‘:**
1. Kafka ä¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„è¯·æ±‚
2. Producer ç«¯æœ‰å‘é€ç¼“å†²åŒº
3. Broker ç«¯æœ‰æ¥æ”¶ç¼“å†²åŒº
4. å³ä½¿ fsync æ…¢ï¼Œå‰é¢çš„ç¼“å†²å±‚ä¼šå…ˆè¶…æ—¶ï¼ˆè§¦å‘å…¶ä»–é”™è¯¯ï¼‰

### 4.4 ç¼“å­˜çš„å½±å“

å³ä½¿ä½¿ç”¨ `oflag=sync`ï¼Œä»æœ‰å¤šå±‚ç¼“å­˜ï¼š

```
Application Layer
    â†“
Page Cache (ä»éƒ¨åˆ†æœ‰æ•ˆ)
    â†“
Filesystem Cache
    â†“
Device Write Cache
    â†“
SSD Controller Cache
    â†“
Physical Flash
```

é«˜æ€§èƒ½ SSD çš„å†…ç½®ç¼“å­˜å¯ä»¥å¸æ”¶å¤§é‡åŒæ­¥å†™å…¥è¯·æ±‚ã€‚

---

## äº”ã€ä¸ Redis æµ‹è¯•çš„å¯¹æ¯”

### 5.1 Redis å¤ç°æˆåŠŸçš„æ¡ˆä¾‹

| é”™è¯¯ç±»å‹ | æˆåŠŸç‡ | å…³é”®é…ç½® |
|---------|--------|----------|
| Connection Pool Exhaustion | 100% | maxWaitMillis=20ms, 25 threads vs 16 pool |
| Connection Timeout | 95-100% | TEST-NET-1 IP / 1ms timeout |
| Network Exception | 100% | testOnBorrow=false + manual shutdown |

**æˆåŠŸåŸå› :**
1. **æ˜ç¡®çš„è§¦å‘æ¡ä»¶:** èµ„æºæ•°é‡ã€è¶…æ—¶æ—¶é—´éƒ½æ˜¯ç¡®å®šçš„
2. **å¯æ§çš„çŠ¶æ€:** å¯ä»¥ç²¾ç¡®æ§åˆ¶è¿æ¥æ•°ã€è¶…æ—¶æ—¶é—´
3. **ç‹¬ç«‹æ€§:** ä¸ä¾èµ–åº•å±‚ç¡¬ä»¶æ€§èƒ½

### 5.2 Kafka å¤±è´¥çš„åŸå› 

| æ–¹æ³• | é—®é¢˜ | æµ‹è¯•æ¬¡æ•° |
|------|------|----------|
| é…ç½®è¶…æ—¶å‚æ•° | è§¦å‘å…¶ä»–è¶…æ—¶é”™è¯¯ | 4æ¬¡ |
| TCP ä»£ç†é˜»æ–­ | OS ç¼“å†²åŒºç»•è¿‡ | 3æ¬¡ |
| Docker pause | è§¦å‘è¿æ¥é”™è¯¯ | 2æ¬¡ |
| iptables DROP | è§¦å‘ç½‘ç»œé”™è¯¯ | 1æ¬¡ |
| ç£ç›˜å¡«æ»¡ | Kafka é¢„åˆ†é…æ®µä»æˆåŠŸ | 1æ¬¡ |
| dd I/O å‹åŠ› (20ä¸ª) | Kafka å®Œå…¨æ— æ³•è¿æ¥ | 1æ¬¡ |
| **dd I/O å‹åŠ› (5-15ä¸ª)** | **æ‰€æœ‰æ¶ˆæ¯æˆåŠŸ** | **4æ¬¡** âœ…æœ¬æ¬¡æµ‹è¯• |

**æ€»è®¡:** è‡³å°‘ **16 ç§ä¸åŒæ–¹æ³•/é…ç½®**ï¼Œå…¨éƒ¨å¤±è´¥

---

## å…­ã€ä¸“ä¸šç»“è®º

### 6.1 æŠ€æœ¯ç»“è®º

**Kafka "batch creation" timeout åœ¨æµ‹è¯•ç¯å¢ƒä¸­æéš¾å¤ç°ï¼ŒåŸå› :**

1. **ç¡¬ä»¶ä¾èµ–æ€§å¼º**
   - éœ€è¦çœŸå®çš„æ…¢ç›˜ç¯å¢ƒï¼ˆè€åŒ–çš„ HDD æˆ– SSDï¼‰
   - é«˜æ€§èƒ½ç¡¬ä»¶ï¼ˆSSD + å¼ºCPUï¼‰å‡ ä¹ä¸å¯èƒ½è§¦å‘

2. **çŠ¶æ€çª—å£æçª„**
   - "ç°è‰²æ•…éšœ"çŠ¶æ€éš¾ä»¥ç¨³å®šç»´æŒ
   - è¦ä¹ˆå®Œå…¨æ­£å¸¸ï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥
   - ä¸­é—´çŠ¶æ€ä¸ç¨³å®šä¸”æçŸ­æš‚

3. **å¤šå±‚å®¹é”™æœºåˆ¶**
   - Kafka çš„é‡è¯•æœºåˆ¶ä¼šå…ˆè§¦å‘
   - å…¶ä»–è¶…æ—¶ï¼ˆrequest.timeout, delivery.timeoutï¼‰ä¼šå…ˆå‘ç”Ÿ
   - batch creation timeout æ˜¯"æœ€åä¸€é“é˜²çº¿"

4. **ç¯å¢ƒå› ç´ å¤æ‚**
   - ç¼“å­˜æœºåˆ¶ï¼ˆå¤šå±‚ï¼‰
   - è™šæ‹ŸåŒ–å½±å“ï¼ˆDocker for Macï¼‰
   - æ“ä½œç³»ç»Ÿè°ƒåº¦ç­–ç•¥

### 6.2 ä¸ALM-12033 çš„å…³ç³»

**åä¸º ALM-12033 æ…¢ç›˜æ£€æµ‹** æ˜¯åŸºäºç”Ÿäº§ç¯å¢ƒçš„é•¿æœŸç›‘æ§ï¼š
- ç›‘æ§çª—å£ï¼š30ç§’ / 300ç§’
- é‡‡æ ·é¢‘ç‡ï¼šæŒç»­ç›‘æ§
- è§¦å‘æ¡ä»¶ï¼šç»Ÿè®¡å­¦é˜ˆå€¼ï¼ˆ7æ¬¡ / 50%ï¼‰

è¿™ç§æ£€æµ‹æ–¹æ³•åœ¨**ç”Ÿäº§ç¯å¢ƒ**æœ‰æ•ˆï¼Œå› ä¸ºï¼š
- çœŸå®çš„ç¡¬ä»¶è€åŒ–
- é•¿æœŸè¿è¡Œç§¯ç´¯çš„é—®é¢˜
- å¤§è§„æ¨¡æ•°æ®å†™å…¥

ä½†åœ¨**æµ‹è¯•ç¯å¢ƒ**éš¾ä»¥æ¨¡æ‹Ÿï¼Œå› ä¸ºï¼š
- ç¡¬ä»¶æ€§èƒ½å¤ªå¥½
- æµ‹è¯•æ—¶é—´å¤ªçŸ­
- æ— æ³•çœŸå®æ¨¡æ‹Ÿç¡¬ä»¶è€åŒ–

### 6.3 å®è·µå»ºè®®

**å¯¹äº Kafka batch creation timeoutï¼š**

| æ¨èæ–¹æ³• | ä¼˜å…ˆçº§ | åŸå›  |
|---------|--------|------|
| **ç”Ÿäº§ç›‘æ§** | ğŸ”¥ğŸ”¥ğŸ”¥ æœ€é«˜ | å”¯ä¸€å¯é çš„å‘ç°é€”å¾„ |
| **Mock æµ‹è¯•** | ğŸ”¥ğŸ”¥ é«˜ | å¯æ§ã€å¯é‡å¤ |
| **å‹æµ‹ + ç›‘æ§** | ğŸ”¥ ä¸­ | èƒ½å‘ç°å…¶ä»–æ€§èƒ½é—®é¢˜ |
| **æµ‹è¯•ç¯å¢ƒå¤ç°** | âŒ æ”¾å¼ƒ | æŠ•å…¥äº§å‡ºæ¯”æä½ |

**å…·ä½“æ“ä½œ:**

1. **ç”Ÿäº§ç¯å¢ƒç›‘æ§ï¼ˆæ¨èï¼‰**
   ```java
   // åœ¨ç”Ÿäº§ä»£ç ä¸­æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   producer.send(record, (metadata, exception) -> {
       if (exception != null) {
           logger.error("Message send failed", exception);
           // ç‰¹åˆ«è®°å½• batch creation timeout
           if (exception.getMessage().contains("batch creation")) {
               alertSystem.trigger("BATCH_CREATION_TIMEOUT", exception);
           }
       }
   });
   ```

2. **ä½¿ç”¨ Mock è¿›è¡Œå•å…ƒæµ‹è¯•**
   ```java
   @Test
   public void testBatchCreationTimeout() {
       KafkaProducer mockProducer = Mockito.mock(KafkaProducer.class);
       Mockito.when(mockProducer.send(any()))
              .thenThrow(new TimeoutException("60000ms has passed since batch creation"));

       // æµ‹è¯•åº”ç”¨çš„é”™è¯¯å¤„ç†é€»è¾‘
       myService.sendMessage(mockProducer, message);
       verify(errorHandler).handle(any(TimeoutException.class));
   }
   ```

3. **å¥å£®çš„é”™è¯¯å¤„ç†ä»£ç **
   ```java
   try {
       producer.send(record).get(timeout, TimeUnit.MILLISECONDS);
   } catch (TimeoutException e) {
       // ç»Ÿä¸€å¤„ç†æ‰€æœ‰è¶…æ—¶é”™è¯¯
       logger.error("Send timeout: {}", e.getMessage());
       retryStrategy.handle(record, e);
   } catch (Exception e) {
       logger.error("Send failed: {}", e.getMessage());
       errorHandler.handle(record, e);
   }
   ```

---

## ä¸ƒã€æµ‹è¯•èµ„äº§

### 7.1 åˆ›å»ºçš„æ–‡ä»¶

#### é…ç½®æ–‡ä»¶
- `fio-slow-disk-hdd.fio` (641B) - fio æ¸©å’Œå‹åŠ›é…ç½®
- `fio-slow-disk-extreme.fio` (786B) - fio æç«¯å‹åŠ›é…ç½®

#### è„šæœ¬æ–‡ä»¶
- `monitor-svctm.sh` (2.7K) - svctm ç›‘æ§è„šæœ¬
- `run-fio-kafka-test.sh` (6.1K) - è‡ªåŠ¨åŒ–æµ‹è¯•ç¼–æ’

#### æ–‡æ¡£æ–‡ä»¶
- `FIO-APPROACH.md` (8.5K) - fio æ–¹æ¡ˆå®Œæ•´æ–‡æ¡£
- `BATCH-CREATION-TIMEOUT-TEST-SUMMARY.md` (æœ¬æ–‡æ¡£) - æµ‹è¯•æ€»ç»“æŠ¥å‘Š

#### æµ‹è¯•ä»£ç 
- `TestBatchCreationProgressiveIO.java` - æ¸è¿›å¼ I/O å‹åŠ›æµ‹è¯•
- `TestBatchCreationDiskBusy.java` - ç£ç›˜ç¹å¿™æµ‹è¯•
- `TestBatchCreationWithProxyV2.java` - TCP ä»£ç†æµ‹è¯•
- `KafkaTcpProxy.java` - è‡ªå®šä¹‰ TCP ä»£ç†
- (ä»¥åŠä¹‹å‰åˆ›å»ºçš„å…¶ä»– 10+ ä¸ªæµ‹è¯•ç±»)

### 7.2 æµ‹è¯•æ•°æ®

**æ€»æµ‹è¯•æ¬¡æ•°:** 16+ ç§ä¸åŒæ–¹æ³•
**æ€»æµ‹è¯•æ—¶é•¿:** çº¦ 8+ å°æ—¶ï¼ˆè·¨å¤šä¸ªä¼šè¯ï¼‰
**æ¶ˆæ¯å‘é€é‡:** æ•°åƒæ¡
**Docker å®¹å™¨é‡å¯:** 5+ æ¬¡
**I/O å‹åŠ›æµ‹è¯•:** 4 è½®ï¼ˆ5, 7, 10, 15 ä¸ª dd è¿›ç¨‹ï¼‰

---

## å…«ã€æœ€ç»ˆå»ºè®®

### 8.1 å¯¹äºæœ¬é¡¹ç›®

**ä¸å†å°è¯•å¤ç°æ­¤ç‰¹å®šé”™è¯¯**ï¼ŒåŸå› ï¼š
1. å·²ç»å°è¯•äº† 16+ ç§æ–¹æ³•ï¼Œå…¨éƒ¨å¤±è´¥
2. ç¡¬ä»¶ç¯å¢ƒä¸æ”¯æŒï¼ˆé«˜æ€§èƒ½ SSD + ARM64ï¼‰
3. æŠ•å…¥æ—¶é—´ä¸æ”¶ç›Šä¸æˆæ­£æ¯”
4. å·²ç»è¯æ˜äº†è¯¥é”™è¯¯åœ¨æµ‹è¯•ç¯å¢ƒæéš¾å¤ç°

**è½¬è€Œä¸“æ³¨äº:**
1. âœ… **Redis é”™è¯¯å¤ç°**ï¼ˆå·²100%æˆåŠŸï¼‰
2. âœ… **å…¶ä»– Kafka é”™è¯¯**ï¼ˆç½‘ç»œè¶…æ—¶ã€è¿æ¥é”™è¯¯ç­‰æ›´å¸¸è§çš„é”™è¯¯ï¼‰
3. âœ… **å¥å£®çš„é”™è¯¯å¤„ç†é€»è¾‘**ï¼ˆç»Ÿä¸€å¤„ç†å„ç§è¶…æ—¶ï¼‰
4. âœ… **ç”Ÿäº§ç›‘æ§å’Œå‘Šè­¦**ï¼ˆçœŸå®ç¯å¢ƒä¸‹çš„å‘ç°å’Œå“åº”ï¼‰

### 8.2 çŸ¥è¯†ä»·å€¼

è™½ç„¶æœªèƒ½æˆåŠŸå¤ç°ï¼Œä½†æœ¬æ¬¡æµ‹è¯•æœ‰é‡è¦ä»·å€¼ï¼š

**æŠ€æœ¯æ·±åº¦:**
- æ·±å…¥ç†è§£äº† Kafka Producer çš„è¶…æ—¶æœºåˆ¶
- å­¦ä¹ äº†ç£ç›˜ I/O ç›‘æ§æŒ‡æ ‡ (svctm, await, %util)
- æŒæ¡äº† fio æ€§èƒ½æµ‹è¯•å·¥å…·çš„åŸç†
- ç†è§£äº†å¤šå±‚ç¼“å­˜å¯¹ I/O æ€§èƒ½çš„å½±å“

**æµ‹è¯•æ–¹æ³•è®º:**
- æ¸è¿›å¼æµ‹è¯•ç­–ç•¥ï¼ˆäºŒåˆ†æœç´¢ï¼‰
- è‡ªåŠ¨åŒ–æµ‹è¯•ç¼–æ’
- é—®é¢˜è¯Šæ–­å’Œæ ¹å› åˆ†æ
- ä¸“ä¸šçš„æµ‹è¯•æ€»ç»“å’Œæ–‡æ¡£

**å·¥ç¨‹å®è·µ:**
- æ˜ç¡®äº†æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚
- å­¦ä¼šäº†ä½•æ—¶æ”¾å¼ƒã€ä½•æ—¶åšæŒ
- ç†è§£äº†æŠ•å…¥äº§å‡ºæ¯”çš„é‡è¦æ€§
- Mock æµ‹è¯• vs çœŸå®ç¯å¢ƒæµ‹è¯•çš„æƒè¡¡

---

## ä¹ã€å‚è€ƒèµ„æ–™

1. **Kafka å®˜æ–¹æ–‡æ¡£**
   - Producer Configuration: https://kafka.apache.org/documentation/#producerconfigs
   - Timeout Configuration: https://kafka.apache.org/documentation/#timeout-configs

2. **fio æ€§èƒ½æµ‹è¯•**
   - fio Official Documentation: https://fio.readthedocs.io/
   - Linux I/O Performance Tuning

3. **ALM-12033 æ…¢ç›˜æ£€æµ‹**
   - åä¸ºå­˜å‚¨å‘Šè­¦å‚è€ƒï¼ˆç”¨æˆ·æä¾›çš„æˆªå›¾ï¼‰
   - svctm æŒ‡æ ‡è¯´æ˜

4. **Docker & Kafka**
   - Confluent Platform Docker Images
   - Docker for Mac Performance Considerations

---

**æŠ¥å‘Šç»“è®º:**
Kafka "batch creation" timeout åœ¨é«˜æ€§èƒ½æµ‹è¯•ç¯å¢ƒä¸­**å‡ ä¹ä¸å¯èƒ½å¤ç°**ã€‚å»ºè®®å°†èµ„æºæŠ•å…¥åˆ°æ›´å®ç”¨çš„æµ‹è¯•æ–¹å‘ï¼ˆRedis é”™è¯¯å¤ç°ã€é€šç”¨è¶…æ—¶å¤„ç†ã€ç”Ÿäº§ç›‘æ§ï¼‰ï¼Œè€Œä¸æ˜¯ç»§ç»­è¿½æ±‚è¿™ä¸ªæä½æ¦‚ç‡çš„ç‰¹å®šé”™è¯¯ã€‚

**æŠ¥å‘Šä½œè€…:** Claude (assisted by AI)
**å®¡æ ¸çŠ¶æ€:** âœ… æŠ€æœ¯åˆ†æå®Œæˆ
**æ‰§è¡ŒçŠ¶æ€:** âœ… æµ‹è¯•ä»»åŠ¡ç»ˆæ­¢ï¼ˆæŠ•å…¥äº§å‡ºæ¯”è€ƒé‡ï¼‰
